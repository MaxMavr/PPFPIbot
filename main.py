#
# ⠀     ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀  ⠀⣴⣶⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀          ⢰⣶⣿⣿⣿⣿⣿⡆
# ⠀     ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀ ⢰⣿⡏⠀⠀⠀⢸⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀       ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀   ⢰⣿⡏⠀⠀⠀⢸⣿⡇
# ⠀     ⠀⠀⠀⠀⠀⠀⣴⣿⣿⣿⣿⣿⣷⣤⣤⣤⣄⠀⣾⣿⠁⠀⠀⠀⣿⣿⣤⣤⣀⠀⠀⠀⠀⠀⣀⣠⣤⣤⣤⣤⣤⣤⣤⣤⣄⠀⠀⣠⣴⣶⣶⣶⣶⣦⡀⠀⠀⠀⣀⣠⣤⣤⣤⣤⣤⣤⣤⣄⣀⣿⡿⠀⠀⠀⢰⣿⡏⠀⢀⣀⣤⣤⣤⣤⣀
# ⠀     ⠀⠀⠀⠀⠀⢸⣿⡏⠀⠀⠀⠸⠟⠛⠛⠛⢿⣿⣿⡿⠀⠀⠀⢸⠿⠛⠛⠻⢿⣿⣄⠀⣴⣾⡿⠟⠛⠛⠛⠿⠛⠛⠛⢻⣿⡇⣸⣿⠟⠉⠉⠉⢹⣿⡇⣾⡿⠟⠛⠛⠛⠿⠛⠛⠛⢻⣿⣿⡏⠀⠀ ⣼⣿⣡⣶⣿⠿⠟⠛⠛⠻⢿⣿⣆
# ⠀     ⠀⠀⠀⠀⠀⣾⣿⠁⠀⠀⠀⣠⣤⡄⠀⠀⠀⢿⣿⠇⠀⠀⠀⢀⣀⡀⠀⠀⠀⢿⣿⣾⣿⠋⠀⠀⢀⣴⣶⡄⠀⠀⠀⣼⣿⢣⣿⡿⠀⠀⠀⠀⢸⣿⣷⣿⡿⠃⠀⠀⢠⣤⣤⠀⠀⠀⠀⣿⣿⣿⡏⠀⠀  ⣿⣿⣿⠟⠁⠀⠀⣤⣶⡄⠀⢻⣿⡄
# ⠀     ⠀⠀⠀⠀⢠⣿⡟⠀⠀⠀⢰⣿⣿⣿⠀⠀⠀⢸⣿⠀⠀⠀⢠⣾⣿⡇⠀⠀⠀⣾⣿⡿⠁⠀⠀⢠⣿⣿⣿⠁⠀⠀⠀⣿⣿⣿⣿⠁⣼⠀⠀⠀⠸⣿⣿⡟⠀⠀⠀⣰⣿⣿⡟⠀⠀⠀⢸⣿⣿⡏⠀⠀⠀⣼⣿⣿⠋⠀⠀⠀⣼⣿⣿⡇⠀⢸⣿⡇
# ⠀     ⠀⠀⠀⠀⣸⣿⠇⠀⠀⠀⣾⣿⣿⡏⠀⠀⠀⣼⡇⠀⠀⠀⣸⣿⣿⠁⠀⠀⢠⣿⣿⠇⠀⠀⠀⣾⣿⣿⡟⠀⠀⠀⢸⣿⣿⣿⠃⣰⣿⠀⠀⠀⠀⣿⡿⠀⠀⠀⢠⣿⣿⣿⠇⠀⠀⠀⣾⣿⣿⠁⠀⠀⠀⣿⣿⡏⠀⠀⠀⢸⣿⣿⣿⠃⠀⢸⣿⡇
# ⠀     ⠀⠀⠀⢀⣿⣿⠀⠀⠀⢠⣿⣿⣿⠁⠀⠀⢀⣿⠀⠀⠀⢀⣿⣿⡏⠀⠀⠀⣸⣿⣿⠀⠀⠀⢰⣿⣿⣿⠃⠀⠀⠀⣿⣿⡟⠃⠀⣿⣿⠀⠀⠀⠀⣿⡇⠀⠀⠀⢸⣿⣿⡿⠀⠀⠀⢠⣿⣿⡟⠀⠀⠀⢸⣿⣿⠁⠀⠀⠀⣿⣿⣿⡟⠀⠀⣾⣿⠁
# ⠀     ⠀⠀⠀⢸⣿⡇⠀⠀⠀⢼⣿⡿⠃⠀⠀⢀⣼⡟⠀⠀⠀⢸⣿⣿⡇⠀⠀⠀⢿⣿⠏⠀⠀⠀⠘⢿⡿⠏⠀⠀⠀⠀⣿⡿⠀⢠⣤⣿⡿⠀⠀⠀⠀⠋⡀⠀⠀⠀⠸⣿⡿⠃⠀⠀⠀⢸⣿⡿⠁⠀⠀⠀⢿⣿⠟⠀⠀⠀⠀⢿⣿⡟⠁⠀⣼⣿⡏
# ⠀     ⠀⠀⠀⣾⣿⠁⠀⠀⠀⠀⠀⠀⠀⢀⣠⣾⣿⠃⠀⠀⠀⣿⣿⣿⣧⠀⠀⠀⠀⠀⣠⣆⠀⠀⠀⠀⢀⣴⣆⠀⠀⠀⠀⣀⣤⠀⠉⠉⠀⠀⠀⣠⣴⣿⣷⡀⠀⠀⠀⠀⢀⣴⡀⠀⠀⠀⠀⣠⣆⠀⠀⠀⠀⠀⣠⣦⡀⠀⠀⠀  ⠀⠀⣠⣾⣿⠏
# ⠀     ⠀⠀⢰⣿⡏⠀⠀⠀⢸⣿⣶⣶⣿⣿⡿⢿⣿⣷⣶⣶⣾⣿⠏⠙⢿⣿⣶⣶⣾⣿⡿⢿⣿⣶⣶⣾⣿⡿⣿⣷⣶⣶⣿⣿⢿⣿⣶⣶⣶⣾⣿⡿⠟⠉⠻⣿⣷⣶⣶⣾⣿⢿⣿⣶⣶⣶⣿⡿⣿⣷⣶⣶⣶⣿⡿⡿⠟
# ⠀     ⠀⠀⣼⣿⠃⠀⠀⠀⣿⣿⠉
# ⠀     ⠀⢰⣿⡿⠀⠀⠀⢰⣿⡏
# ⠀     ⠀⣾⣿⣷⣶⣶⣿⣿⠿⠁⠀⠀⠀⠀⠀⢀⣶⠿⢿⣶⢀⣶⡆⢀⣶⠆⢠⣾⣿⠀⢀⣴⣶⠿⠇⠀⣾⢿⡇⠀⣴⡿⠀⢀⣴⣶⣷⣶⡄⢀⣾⠿⢿⣦⢀⣶⡾⠿⠇⣾⡿⢿⣶⠀⣴⣶⠀⣴⣿⣷⠀⠀⠀⢠⣾⠿⣿⣦⢀⣶⠆⢰⣿⠂
#                 ⠀⠀⠀⠀⠀⠀⣼⣿⣤⣾⠟⣸⣿⣶⣾⡟⢠⣿⣃⣿⡇⠘⢿⣧⡀⠀⣼⣏⣸⡇⢠⣿⠃⠀⣾⡟⠁⠈⣿⠇⣼⣿⣤⣾⠏⣸⡿⠶⠆⢸⣿⠁⣸⣿⢠⣿⠇⣸⣟⣸⣿⠀⠀⠀⣾⣿⣤⡿⠋⣼⡟⠀⣾⡏
# ⠀     ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠋⠉⠀⠀⣿⠇⠠⠿⠃⠿⠛⠻⣿⠡⣶⣶⠿⠟⠼⠟⠛⣿⡇⣾⣿⡶⠆⠻⢿⣶⠾⠋⢠⣿⠋⠉⠀⠠⠿⠷⠶⠀⢿⣷⠾⠟⠁⣼⡟⠰⠿⠛⢻⡿⠠⡶⢰⡿⠉⢿⠇⠀⢿⣷⣾⠟⠁
#

import asyncio
from aiogram import Dispatcher

from config import bot
from bot.middlewares.get_user import GetUserMiddleware
from bot.middlewares.shadow_ban import ShadowBanMiddleware
from bot.middlewares.logging_query import UserRegistrationMiddleware
from bot.handlers import callbacks, user_handlers, commands, admin_handlers
from DB import init_database
import logging

logger = logging.getLogger(__name__)


async def main() -> None:
    logger.info('Creating db tables')
    init_database()

    dp = Dispatcher()

    logger.info('Including routers')
    dp.include_router(admin_handlers.router)
    dp.include_router(commands.router)
    dp.include_router(user_handlers.router)
    dp.include_router(callbacks.router)

    logger.info('Including middlewares')
    dp.update.middleware(GetUserMiddleware())
    dp.update.middleware(ShadowBanMiddleware())
    dp.message.middleware.register(UserRegistrationMiddleware())

    logger.info('Пост-поп-трах-панк-инди-бот полетел!')
    try:
        await dp.start_polling(bot)
    except Exception as e:
        logger.exception(e)


if __name__ == '__main__':
    asyncio.run(main())
